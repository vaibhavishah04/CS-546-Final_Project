<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="/public/css/styles.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <title>Sensor Details - NJFloodNet</title>
  </head>

  <body>
    <!-- Include header -->
    <div><%- include('../partials/header'); %></div>

    <header>
      <div class="logo"></div>
      <nav class="navigation">
        <ul>
          <li><a href="/">Map</a></li>
          <li><a href="/dashboard">Dashboard</a></li>
          <li><a href="/reporting">Reporting</a></li>
          <li><a href="/about">About FloodNet</a></li>
        </ul>
      </nav>
    </header>

    <div class="container my-4">
      <h1 class="text-center mb-4">Sensor Details</h1>

      <!-- Display Sensor Information -->
      <% if (sensor) { %>
        <div class="card mb-4">
          <div class="card-header text-center">
            
            <h3>Sensor <%= sensor.sensorNumber %>: <%= sensor.sensorName %></h3>
            <p><strong>Location:</strong> <%= sensor.location %></p>
            <p><strong>Status:</strong> <%= sensor.status %></p>
            <p><strong>Coordinates:</strong> <%= sensor.coords %></p>
            <p><strong>Notes:</strong> <%= sensor.notes.length > 0 ? sensor.notes.join(', ') : "No notes available" %></p>
          </div>
          <div class="card-body text-center">
            <img
              src="<%= sensor.image.startsWith('./') ? sensor.image.replace('./', '/public/') : sensor.image %>"
              alt="Sensor Image"
              style="max-width: 100%; height: auto; border-radius: 8px;"
            />
          </div>
        </div>
        <div class="text-center my-4">
          <button id="downloadData" class="btn btn-primary">Download Sensor Data</button>
        </div>
        <!-- Display Sensor Measurements -->
        <div class="card">
          <div class="card-header text-center">
            <h3>Measurement Data</h3>
          </div>
          <div class="card-body">
            <% if (sensor.measurements && sensor.measurements.length > 0) { %>
              <canvas id="chart-<%= sensor._id %>" class="chart"></canvas>
            <% } else { %>
              <p class="text-center">No measurement data available for this sensor.</p>
            <% } %>
          </div>
        </div>
      <% } else { %>
        <p class="text-center">Sensor not found.</p>
      <% } %>
    </div>

    <!-- Include footer -->
    <div><%- include('../partials/footer'); %></div>

    <!-- JavaScript for rendering chart -->
    <script>

  document.getElementById("downloadData").addEventListener("click", function () {
    const sensorId = "<%= sensor._id %>";

      $.ajax({
      url: `/sensors/${sensorId}/download`,
      method: "GET",
      xhrFields: {
        responseType: "blob",
      },
      success: function (data, status, xhr) {
        const disposition = xhr.getResponseHeader("Content-Disposition");
        const filename = disposition
          ? disposition.match(/filename="(.+)"/)[1]
          : `sensor_${sensorId}.json`;

        const url = window.URL.createObjectURL(data);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(url);
      },
      error: function (xhr, status, error) {
        console.error("Error:", error);
        alert("Not able to doanload the data. Please try again later.");
      },
    });
  });
      document.addEventListener("DOMContentLoaded", function () {
        <% if (sensor && sensor.measurements && sensor.measurements.length > 0) { %>
          const ctx = document.getElementById("chart-<%= sensor._id %>").getContext("2d");

          // Extract timestamps and flood depths (or other relevant data)
          const timestamps = <%- JSON.stringify(sensor.measurements.map(m => m.timestamp.toString())) %>;
          const floodDepths = <%- JSON.stringify(sensor.measurements.map(m => m.distanceMm)) %>;

          new Chart(ctx, {
            type: "line",
            data: {
              labels: timestamps,
              datasets: [
                {
                  label: "Flood Depth (mm)",
                  data: floodDepths,
                  borderColor: "#3b93bd",
                  backgroundColor: "rgba(0, 123, 255, 0.2)",
                },
              ],
            },
            options: { responsive: true },
          });
        <% } %>
      });
    </script>
    <script src="/public/js/main.js"></script>
  </body>
</html>


